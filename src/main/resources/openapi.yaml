openapi: 3.0.3
info:
  title: 学園祭会計アプリ API
  description: 学園祭の出店で使用する会計・在庫管理アプリのAPI仕様書
  version: 1.0.0

tags:
  - name: products
    description: 商品管理
  - name: transactions
    description: 会計・取引管理
  - name: reports
    description: 売上レポート

paths:

  # ==================== 商品管理 ====================

  /api/products:
    get:
      tags: [products]
      summary: 商品一覧取得
      responses:
        '200':
          description: 商品一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductResponse'

    post:
      tags: [products]
      summary: 商品登録
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductRequest'
      responses:
        '201':
          description: 登録された商品
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'

  /api/products/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64

    get:
      tags: [products]
      summary: 商品詳細取得
      responses:
        '200':
          description: 商品詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: 商品が存在しない

    put:
      tags: [products]
      summary: 商品更新
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductUpdateRequest'
      responses:
        '200':
          description: 更新された商品
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductResponse'
        '404':
          description: 商品が存在しない

    delete:
      tags: [products]
      summary: 商品論理削除（enabled=false に更新）
      responses:
        '204':
          description: 削除成功
        '404':
          description: 商品が存在しない

  # ==================== 会計・取引管理 ====================

  /api/transactions:
    get:
      tags: [transactions]
      summary: 取引履歴一覧取得
      responses:
        '200':
          description: 取引一覧
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TransactionSummaryResponse'

    post:
      tags: [transactions]
      summary: 会計実行
      description: |
        在庫チェック → 合計・お釣り計算 → Transaction/TransactionItem 作成 → 在庫減算
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionRequest'
      responses:
        '201':
          description: 会計結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetailResponse'
        '400':
          description: 在庫不足 または 預かり金が合計金額未満
        '404':
          description: 存在しない商品ID

  /api/transactions/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
          format: int64

    get:
      tags: [transactions]
      summary: 取引詳細取得
      responses:
        '200':
          description: 取引詳細
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetailResponse'
        '404':
          description: 取引が存在しない

  # ==================== 売上レポート ====================

  /api/reports/summary:
    get:
      tags: [reports]
      summary: 売上サマリー取得
      parameters:
        - $ref: '#/components/parameters/DateParam'
      responses:
        '200':
          description: 売上サマリー
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SummaryResponse'

  /api/reports/by-product:
    get:
      tags: [reports]
      summary: 商品別売上集計
      parameters:
        - $ref: '#/components/parameters/DateParam'
      responses:
        '200':
          description: 商品別集計
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProductSalesResponse'

  /api/reports/by-hour:
    get:
      tags: [reports]
      summary: 時間帯別売上集計
      parameters:
        - $ref: '#/components/parameters/DateParam'
      responses:
        '200':
          description: 時間帯別集計
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/HourlySalesResponse'

# ==================== 共通定義 ====================

components:

  parameters:
    DateParam:
      name: date
      in: query
      required: false
      description: 集計対象日（省略時は当日）
      schema:
        type: string
        format: date
        example: "2024-11-01"

  schemas:

    # ---------- 商品 ----------

    ProductRequest:
      type: object
      required: [name, price, stock]
      properties:
        name:
          type: string
          example: "たこ焼き"
        price:
          type: integer
          example: 200
        stock:
          type: integer
          example: 50

    ProductUpdateRequest:
      type: object
      required: [name, price, stock, enabled]
      properties:
        name:
          type: string
          example: "たこ焼き"
        price:
          type: integer
          example: 250
        stock:
          type: integer
          example: 30
        enabled:
          type: boolean
          example: true

    ProductResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: "たこ焼き"
        price:
          type: integer
          example: 200
        stock:
          type: integer
          example: 50
        enabled:
          type: boolean
          example: true

    # ---------- 取引 ----------

    TransactionRequest:
      type: object
      required: [receivedAmount, items]
      properties:
        receivedAmount:
          type: integer
          example: 1000
        items:
          type: array
          items:
            $ref: '#/components/schemas/TransactionItemRequest'

    TransactionItemRequest:
      type: object
      required: [productId, quantity]
      properties:
        productId:
          type: integer
          format: int64
          example: 1
        quantity:
          type: integer
          example: 2

    TransactionSummaryResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        totalAmount:
          type: integer
          example: 700
        receivedAmount:
          type: integer
          example: 1000
        changeAmount:
          type: integer
          example: 300
        createdAt:
          type: string
          format: date-time
          example: "2024-11-01T12:30:00"

    TransactionDetailResponse:
      allOf:
        - $ref: '#/components/schemas/TransactionSummaryResponse'
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: '#/components/schemas/TransactionItemResponse'

    TransactionItemResponse:
      type: object
      properties:
        productName:
          type: string
          example: "たこ焼き"
        unitPrice:
          type: integer
          example: 200
        quantity:
          type: integer
          example: 2

    # ---------- レポート ----------

    SummaryResponse:
      type: object
      properties:
        date:
          type: string
          format: date
          example: "2024-11-01"
        totalAmount:
          type: integer
          example: 15000
        transactionCount:
          type: integer
          example: 32

    ProductSalesResponse:
      type: object
      properties:
        productName:
          type: string
          example: "たこ焼き"
        quantitySold:
          type: integer
          example: 40
        totalAmount:
          type: integer
          example: 8000

    HourlySalesResponse:
      type: object
      properties:
        hour:
          type: integer
          example: 12
        transactionCount:
          type: integer
          example: 15
        totalAmount:
          type: integer
          example: 7500